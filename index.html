<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>L/R Master v28 Final</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="start-overlay">
    <div style="font-size:3rem; margin-bottom:20px;">ğŸ§</div>
    <h2>L/R Master v28</h2>
    <p>Tap to Unlock Audio</p>
    <button class="start-btn" onclick="unlockAudio()">START</button>
</div>

<div class="container">
    <div class="header-bar">
        <h1 class="app-title">L/R Master</h1>
        <div class="header-tools">
            <button class="btn-icon" onclick="toggleDarkMode()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰">ğŸŒ™</button>
            <button class="btn-icon" onclick="openDbManager()" title="DBç·¨é›†">ğŸ“</button>
            <button class="btn-icon" onclick="openSettings()" style="color:var(--primary);" title="è¨­å®š">âš™ï¸</button>
        </div>
    </div>

    <div class="sub-header">
        <div class="mode-toggle">
            <button class="active" onclick="setMode('speaking')" id="mode-speak">ğŸ¤ Speak</button>
            <button onclick="setMode('listening')" id="mode-listen">ğŸ‘‚ Listen</button>
        </div>
        <select id="category-select" onchange="changeCategory()"></select>
        <span style="font-size:0.8rem; font-weight:bold; color:var(--success);">Streak: <span id="streak-disp">0</span></span>
    </div>

    <div class="flow-options">
        <label><input type="checkbox" id="toggle-auto-flow" checked> ğŸ”„ Auto Next</label>
        <label><input type="checkbox" id="toggle-auto-stop" checked> ğŸ—£ï¸ Auto Stop</label>
    </div>

    <div class="visualizer-box" onclick="toggleVisMode()">
        <canvas id="visualizer"></canvas>
        <div class="vis-label" id="vis-label">BARS</div>
    </div>
    <div class="mic-level" id="mic-debug">Mic Ready</div>

    <div id="word-area">
        <div id="target-word" class="word-display">...</div>
        <div class="sub-text">vs <span id="opponent-word">...</span></div>
    </div>

    <div id="speaking-tools">
        <div id="phoneme-list" class="phoneme-container"></div>
        <div class="diagram-box">
            <div id="diagram-svg" class="mouth-diagram"></div>
            <div class="diagram-text">
                <h4 id="diagram-title">Tip <span id="viseme-tag" style="font-size:0.7em; color:var(--accent); margin-left:5px;"></span></h4>
                <p id="diagram-desc">Select phoneme</p>
            </div>
        </div>
    </div>

    <div id="controls-speaking" class="controls">
        <button class="action-btn btn-skip" onclick="skipQuestion()">Skip</button>
        <button class="action-btn btn-model" onclick="speakModel()">ğŸ”Š Model</button>
        <button id="rec-btn" class="action-btn btn-main" onclick="toggleRecord()">ğŸ¤ Start</button>
        <button id="next-btn-spk" class="action-btn btn-next" onclick="nextQuestion()">Next â¡</button>
    </div>

    <div id="controls-listening" class="controls" style="display:none; grid-template-columns: 1fr 1fr;">
        <button id="choice-l" class="choice-btn" onclick="checkListening(true)">L</button>
        <button id="choice-r" class="choice-btn" onclick="checkListening(false)">R</button>
        <button class="action-btn btn-skip" onclick="skipQuestion()">Skip</button>
        <button class="action-btn btn-model" onclick="speakModel()">ğŸ”Š Replay</button>
        <button id="next-btn-lst" class="action-btn btn-next" onclick="nextQuestion()" style="grid-column: span 2;">Next â¡</button>
    </div>

    <div id="feedback-area" class="feedback">Ready</div>
    <button id="replay-user-btn" onclick="replayUserAudio()">â–¶ï¸ Replay My Voice</button>

    <div class="history-container">
        <div style="font-size:0.8rem; font-weight:bold; color:var(--primary); margin-bottom:5px;">ğŸ“œ History</div>
        <ul id="history-list" class="history-list"></ul>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>âš™ï¸ API Settings</h3><button class="btn-icon" onclick="closeSettings()">Ã—</button></div>
        <div style="text-align:left;">
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:bold; color:var(--text);">1. Gemini API Key</label>
                <input type="password" id="api-key" placeholder="Gemini API Key" style="width:100%; padding:10px; margin-top:5px; box-sizing:border-box; border-radius:6px; border:1px solid rgba(128,128,128,0.3); background:rgba(128,128,128,0.1); color:var(--text);">
                <button onclick="fetchModels()" class="btn-small" style="width:100%; margin-top:5px;">ğŸ”„ Update Models</button>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:bold; color:var(--text);">2. AI Model</label>
                <select id="model-select" style="width:100%; padding:10px; margin-top:5px; box-sizing:border-box;" disabled><option>Fetch first...</option></select>
            </div>

            <div style="margin-bottom:20px;">
                <label style="font-size:0.8rem; font-weight:bold; color:var(--text);">3. ğŸ—£ï¸ Speech Speed: <span id="rate-val">0.8</span>x</label>
                <input type="range" id="speech-rate" min="0.5" max="1.5" step="0.1" value="0.8" style="width:100%; margin-top:5px;" oninput="document.getElementById('rate-val').innerText=this.value">
            </div>

            <button onclick="saveSettings()" class="btn-main" style="width:100%; padding:12px; border:none; border-radius:8px; cursor:pointer;">Save</button>
        </div>
    </div>
</div>

<div id="db-manager-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header"><h3>ğŸ“ DB Manager</h3><button class="btn-icon" onclick="closeDbManager()">Ã—</button></div>
        <div id="db-list-view" style="flex-grow:1; overflow-y:auto;">
            <ul id="db-level-list" class="db-list"></ul>
            <button onclick="addNewLevel()" style="width:100%; padding:10px; margin-top:10px; background:rgba(128,128,128,0.1); border:1px dashed var(--text); cursor:pointer; color:var(--text);">+ Add Level</button>
            <button onclick="resetDb()" style="margin-top:15px; background:none; border:none; color:var(--err); text-decoration:underline; cursor:pointer;">Reset Defaults</button>
        </div>
        <div id="db-editor-view" style="display:none; flex-direction:column; height:100%;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span id="editing-level-name" style="font-weight:bold;"></span>
                <button onclick="cancelEditLevel()" class="btn-small" style="background:gray;">Back</button>
            </div>
            <textarea id="level-json-editor" class="editor"></textarea>
            <button onclick="saveLevel()" class="btn-main" style="width:100%; padding:10px; margin-top:10px; border:none; border-radius:6px; cursor:pointer;">Save Changes</button>
        </div>
    </div>
</div>
<script src="script.js"></script>
</body>
</html>
